import{M as e,N as t,P as n,g as r,k as i}from"./index-C4J1J0jf.js";var a=`TaskQueue`,o=`Queue`,s=(e=>(e[e.CRITICAL=3]=`CRITICAL`,e[e.HIGH=2]=`HIGH`,e[e.MEDIUM=1]=`MEDIUM`,e[e.LOW=0]=`LOW`,e))(s||{}),c=class{constructor(e={}){this.queue=[],this.running=0,this.resultTasks=new Map,this.idleListeners=new Set;let{concurrency:t=1,comparator:r,ranker:i,onIdle:a,maxQueueSize:o,autoStart:s=!0,logger:c}=e;this.logger=c??new n,this.opts={concurrency:Math.max(1,t),comparator:r,ranker:i,onIdle:a??(()=>{}),maxQueueSize:o??1/0,autoStart:s}}setComparator(e){this.opts.comparator=e}setRanker(e){this.opts.ranker=e}size(){return this.queue.length}inFlight(){return this.running}isIdle(){return this.queue.length===0&&this.running===0}async drain(){this.isIdle()||await new Promise(e=>{let t=()=>{this.isIdle()&&(this.offIdle(t),e())};this.onIdle(t)})}notifyIdle(){this.isIdle()&&([...this.idleListeners].forEach(e=>e()),this.idleListeners.clear(),this.opts.onIdle())}onIdle(e){this.idleListeners.add(e)}offIdle(e){this.idleListeners.delete(e)}enqueue(t,n={}){let r=this.generateId(),i=n.priority??1,s=new e;if(this.queue.length>=this.opts.maxQueueSize){let e=Error(`Queue is full (maxQueueSize reached).`);return s.reject(e),s}this.resultTasks.set(r,s);let c={id:r,priority:i,meta:n.meta??t.meta,executeFactory:t.execute};this.queue.push(c),this.logger.debug(a,o,`Task enqueued: ${r} | Priority: ${i} | Running: ${this.running} | Queued: ${this.queue.length}`);let l=s.abort.bind(s);return s.abort=e=>{this.logger.debug(a,o,`Task aborted: ${r}`),this.cancel(r),l(e)},this.opts.autoStart&&this.process(!0===n.fifo),s}cancel(e){let t=this.queue.length;this.queue=this.queue.filter(t=>t.id!==e||(t.cancelled=!0,!1)),this.resultTasks.delete(e),t!==this.queue.length&&(this.logger.debug(a,o,`Task cancelled and removed: ${e}`),this.kick())}kick(){queueMicrotask(()=>this.process())}async process(e=!1){for(this.logger.debug(a,o,`process() called | Running: ${this.running} | Concurrency: ${this.opts.concurrency} | Queued: ${this.queue.length}`);this.running<this.opts.concurrency&&this.queue.length>0;){this.logger.debug(a,o,`Starting new task | Running: ${this.running} | Queued: ${this.queue.length}`),e||this.sortQueue();let t=this.queue.shift();if(t.cancelled){this.logger.debug(a,o,`Skipping cancelled task: ${t.id}`);continue}let n=this.resultTasks.get(t.id);n&&(this.running++,(async()=>{let e=null;try{if(e=t.executeFactory(),!e)throw Error(`Task factory returned null/undefined`);e.wait(e=>{n.state.stage===0&&n.resolve(e)},e=>{n.state.stage===0&&(e.type===`abort`?n.abort(e.reason):n.reject(e.reason))}),e.onProgress(e=>{n.progress(e)}),await e.toPromise()}catch(e){n.state.stage===0&&n.reject(e)}finally{this.resultTasks.delete(t.id),this.running--,this.logger.debug(a,o,`Task completed: ${t.id} | Running: ${this.running} | Queued: ${this.queue.length}`),this.isIdle()?this.notifyIdle():this.queue.length>0&&this.kick()}})().catch(e=>{this.logger.error(a,o,`Unhandled error in task execution wrapper:`,e),this.running=Math.max(0,this.running-1),this.isIdle()?this.notifyIdle():this.queue.length>0&&this.kick()}))}}sortQueue(){let{comparator:e,ranker:t}=this.opts;if(e)return void this.queue.sort(e);let n=new Map,r=e=>t?(n.has(e.id)||n.set(e.id,t(e)),n.get(e.id)):this.defaultRank(e);this.queue.sort((e,t)=>{if(e.priority!==t.priority)return t.priority-e.priority;let n=r(e),i=r(t);return n===i?this.extractTime(e.id)-this.extractTime(t.id):i-n})}defaultRank(e){return 0}generateId(){return typeof crypto<`u`&&`randomUUID`in crypto?crypto.randomUUID():`${Date.now()}-${Math.random().toString(36).slice(2)}`}extractTime(e){let t=Number(e.split(`-`)[0]);return Number.isFinite(t)?t:0}},l=`PdfEngine`,u=`Orchestrator`,d=class{constructor(e,t){this.executor=e,this.logger=t.logger??new n,this.options={imageConverter:t.imageConverter,fetcher:t.fetcher??(typeof fetch<`u`?(e,t)=>fetch(e,t):void 0),logger:this.logger},this.workerQueue=new c({concurrency:1,autoStart:!0,logger:this.logger}),this.logger.debug(l,u,`PdfEngine orchestrator created`)}chunkArray(e,t){let n=[];for(let r=0;r<e.length;r+=t)n.push(e.slice(r,r+t));return n}isSupport(t){let n=new e;return n.resolve([i.Create,i.Read,i.Update,i.Delete]),n}destroy(){let n=new e;try{this.executor.destroy(),n.resolve(!0)}catch(e){n.reject({code:t.Unknown,message:String(e)})}return n}openDocumentUrl(n,r){let i=new e;return(async()=>{try{if(!this.options.fetcher)throw Error(`Fetcher is not set`);let e=await(await this.options.fetcher(n.url,r?.requestOptions)).arrayBuffer(),t={id:n.id,content:e};this.openDocumentBuffer(t,{password:r?.password}).wait(e=>i.resolve(e),e=>i.fail(e))}catch(e){i.reject({code:t.Unknown,message:String(e)})}})(),i}openDocumentBuffer(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.openDocumentBuffer(e,t),meta:{docId:e.id,operation:`openDocumentBuffer`}},{priority:s.CRITICAL})}getMetadata(e){return this.workerQueue.enqueue({execute:()=>this.executor.getMetadata(e),meta:{docId:e.id,operation:`getMetadata`}},{priority:s.MEDIUM})}setMetadata(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.setMetadata(e,t),meta:{docId:e.id,operation:`setMetadata`}},{priority:s.MEDIUM})}getDocPermissions(e){return this.workerQueue.enqueue({execute:()=>this.executor.getDocPermissions(e),meta:{docId:e.id,operation:`getDocPermissions`}},{priority:s.MEDIUM})}getDocUserPermissions(e){return this.workerQueue.enqueue({execute:()=>this.executor.getDocUserPermissions(e),meta:{docId:e.id,operation:`getDocUserPermissions`}},{priority:s.MEDIUM})}getSignatures(e){return this.workerQueue.enqueue({execute:()=>this.executor.getSignatures(e),meta:{docId:e.id,operation:`getSignatures`}},{priority:s.MEDIUM})}getBookmarks(e){return this.workerQueue.enqueue({execute:()=>this.executor.getBookmarks(e),meta:{docId:e.id,operation:`getBookmarks`}},{priority:s.MEDIUM})}setBookmarks(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.setBookmarks(e,t),meta:{docId:e.id,operation:`setBookmarks`}},{priority:s.MEDIUM})}deleteBookmarks(e){return this.workerQueue.enqueue({execute:()=>this.executor.deleteBookmarks(e),meta:{docId:e.id,operation:`deleteBookmarks`}},{priority:s.MEDIUM})}renderPage(e,t,n){return this.renderWithEncoding(()=>this.executor.renderPageRaw(e,t,n),n,e.id,t.index,s.CRITICAL)}renderPageRect(e,t,n,r){return this.renderWithEncoding(()=>this.executor.renderPageRect(e,t,n,r),r,e.id,t.index,s.HIGH)}renderThumbnail(e,t,n){return this.renderWithEncoding(()=>this.executor.renderThumbnailRaw(e,t,n),n,e.id,t.index,s.MEDIUM)}renderPageAnnotation(e,t,n,r){return this.renderWithEncoding(()=>this.executor.renderPageAnnotationRaw(e,t,n,r),r,e.id,t.index,s.MEDIUM)}renderWithEncoding(t,n,r,i,a=s.CRITICAL){let o=new e,c=this.workerQueue.enqueue({execute:()=>t(),meta:{docId:r,pageIndex:i,operation:`render`}},{priority:a}),l=o.abort.bind(o);return o.abort=e=>{c.abort(e),l(e)},c.wait(e=>{o.state.stage===0&&this.encodeImage(e,n,o)},e=>{o.state.stage===0&&o.fail(e)}),o}encodeImage(e,n,r){let i=n?.imageType??`image/webp`,a=n?.quality,o={data:new Uint8ClampedArray(e.data),width:e.width,height:e.height};this.options.imageConverter(()=>o,i,a).then(e=>r.resolve(e)).catch(e=>r.reject({code:t.Unknown,message:String(e)}))}getPageAnnotations(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.getPageAnnotations(e,t),meta:{docId:e.id,pageIndex:t.index,operation:`getPageAnnotations`}},{priority:s.MEDIUM})}createPageAnnotation(e,t,n,r){return this.workerQueue.enqueue({execute:()=>this.executor.createPageAnnotation(e,t,n,r),meta:{docId:e.id,pageIndex:t.index,operation:`createPageAnnotation`}},{priority:s.MEDIUM})}updatePageAnnotation(e,t,n){return this.workerQueue.enqueue({execute:()=>this.executor.updatePageAnnotation(e,t,n),meta:{docId:e.id,pageIndex:t.index,operation:`updatePageAnnotation`}},{priority:s.MEDIUM})}removePageAnnotation(e,t,n){return this.workerQueue.enqueue({execute:()=>this.executor.removePageAnnotation(e,t,n),meta:{docId:e.id,pageIndex:t.index,operation:`removePageAnnotation`}},{priority:s.MEDIUM})}getAllAnnotations(e){let t=this.chunkArray(e.pages,500);this.logger.debug(l,u,`getAllAnnotations: ${e.pages.length} pages in ${t.length} chunks`);let n=new r({aggregate:e=>Object.assign({},...e)});return t.forEach((t,r)=>{let i=this.workerQueue.enqueue({execute:()=>this.executor.getAnnotationsBatch(e,t),meta:{docId:e.id,operation:`getAnnotationsBatch`,chunkSize:t.length}},{priority:s.LOW});i.onProgress(e=>{n.progress({page:e.pageIndex,result:e.result})}),n.addChild(i,r)}),n.finalize(),n}getPageTextRects(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.getPageTextRects(e,t),meta:{docId:e.id,pageIndex:t.index,operation:`getPageTextRects`}},{priority:s.MEDIUM})}searchAllPages(e,t,n){let i=Array.isArray(n?.flags)?n.flags.reduce((e,t)=>e|t,0):n?.flags??0,a=this.chunkArray(e.pages,25);this.logger.debug(l,u,`searchAllPages: ${e.pages.length} pages in ${a.length} chunks`);let o=new r({aggregate:e=>{let t=e.flatMap(e=>Object.values(e).flat());return{results:t,total:t.length}}});return a.forEach((n,r)=>{let a=this.workerQueue.enqueue({execute:()=>this.executor.searchBatch(e,n,t,i),meta:{docId:e.id,operation:`searchBatch`,chunkSize:n.length}},{priority:s.LOW});a.onProgress(e=>{o.progress({page:e.pageIndex,results:e.result})}),o.addChild(a,r)}),o.finalize(),o}getAttachments(e){return this.workerQueue.enqueue({execute:()=>this.executor.getAttachments(e),meta:{docId:e.id,operation:`getAttachments`}},{priority:s.MEDIUM})}addAttachment(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.addAttachment(e,t),meta:{docId:e.id,operation:`addAttachment`}},{priority:s.MEDIUM})}removeAttachment(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.removeAttachment(e,t),meta:{docId:e.id,operation:`removeAttachment`}},{priority:s.MEDIUM})}readAttachmentContent(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.readAttachmentContent(e,t),meta:{docId:e.id,operation:`readAttachmentContent`}},{priority:s.MEDIUM})}setFormFieldValue(e,t,n,r){return this.workerQueue.enqueue({execute:()=>this.executor.setFormFieldValue(e,t,n,r),meta:{docId:e.id,pageIndex:t.index,operation:`setFormFieldValue`}},{priority:s.MEDIUM})}flattenPage(e,t,n){return this.workerQueue.enqueue({execute:()=>this.executor.flattenPage(e,t,n),meta:{docId:e.id,pageIndex:t.index,operation:`flattenPage`}},{priority:s.MEDIUM})}extractPages(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.extractPages(e,t),meta:{docId:e.id,pageIndexes:t,operation:`extractPages`}},{priority:s.MEDIUM})}extractText(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.extractText(e,t),meta:{docId:e.id,pageIndexes:t,operation:`extractText`}},{priority:s.MEDIUM})}redactTextInRects(e,t,n,r){return this.workerQueue.enqueue({execute:()=>this.executor.redactTextInRects(e,t,n,r),meta:{docId:e.id,pageIndex:t.index,operation:`redactTextInRects`}},{priority:s.MEDIUM})}applyRedaction(e,t,n){return this.workerQueue.enqueue({execute:()=>this.executor.applyRedaction(e,t,n),meta:{docId:e.id,pageIndex:t.index,operation:`applyRedaction`}},{priority:s.MEDIUM})}applyAllRedactions(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.applyAllRedactions(e,t),meta:{docId:e.id,pageIndex:t.index,operation:`applyAllRedactions`}},{priority:s.MEDIUM})}flattenAnnotation(e,t,n){return this.workerQueue.enqueue({execute:()=>this.executor.flattenAnnotation(e,t,n),meta:{docId:e.id,pageIndex:t.index,operation:`flattenAnnotation`}},{priority:s.MEDIUM})}getTextSlices(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.getTextSlices(e,t),meta:{docId:e.id,slices:t,operation:`getTextSlices`}},{priority:s.MEDIUM})}getPageGlyphs(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.getPageGlyphs(e,t),meta:{docId:e.id,pageIndex:t.index,operation:`getPageGlyphs`}},{priority:s.MEDIUM})}getPageGeometry(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.getPageGeometry(e,t),meta:{docId:e.id,pageIndex:t.index,operation:`getPageGeometry`}},{priority:s.MEDIUM})}merge(e){return this.workerQueue.enqueue({execute:()=>this.executor.merge(e),meta:{docId:e.map(e=>e.id).join(`,`),operation:`merge`}},{priority:s.MEDIUM})}mergePages(e){return this.workerQueue.enqueue({execute:()=>this.executor.mergePages(e),meta:{docId:e.map(e=>e.docId).join(`,`),operation:`mergePages`}},{priority:s.MEDIUM})}preparePrintDocument(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.preparePrintDocument(e,t),meta:{docId:e.id,operation:`preparePrintDocument`}},{priority:s.MEDIUM})}saveAsCopy(e){return this.workerQueue.enqueue({execute:()=>this.executor.saveAsCopy(e),meta:{docId:e.id,operation:`saveAsCopy`}},{priority:s.MEDIUM})}closeDocument(e){return this.workerQueue.enqueue({execute:()=>this.executor.closeDocument(e),meta:{docId:e.id,operation:`closeDocument`}},{priority:s.MEDIUM})}closeAllDocuments(){return this.workerQueue.enqueue({execute:()=>this.executor.closeAllDocuments(),meta:{operation:`closeAllDocuments`}},{priority:s.MEDIUM})}setDocumentEncryption(e,t,n,r){return this.workerQueue.enqueue({execute:()=>this.executor.setDocumentEncryption(e,t,n,r),meta:{docId:e.id,operation:`setDocumentEncryption`}},{priority:s.MEDIUM})}removeEncryption(e){return this.workerQueue.enqueue({execute:()=>this.executor.removeEncryption(e),meta:{docId:e.id,operation:`removeEncryption`}},{priority:s.MEDIUM})}unlockOwnerPermissions(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.unlockOwnerPermissions(e,t),meta:{docId:e.id,operation:`unlockOwnerPermissions`}},{priority:s.MEDIUM})}isEncrypted(e){return this.workerQueue.enqueue({execute:()=>this.executor.isEncrypted(e),meta:{docId:e.id,operation:`isEncrypted`}},{priority:s.MEDIUM})}isOwnerUnlocked(e){return this.workerQueue.enqueue({execute:()=>this.executor.isOwnerUnlocked(e),meta:{docId:e.id,operation:`isOwnerUnlocked`}},{priority:s.MEDIUM})}},f=class extends Error{constructor(e){super(e),this.name=`ImageConverterError`}},p=(e,t=`image/webp`,n)=>{if(typeof document>`u`)return Promise.reject(new f(`document is not available. This converter requires a browser environment.`));let r=e(),i=new ImageData(r.data,r.width,r.height);return new Promise((e,r)=>{let a=document.createElement(`canvas`);a.width=i.width,a.height=i.height,a.getContext(`2d`).putImageData(i,0,0),a.toBlob(t=>{t?e(t):r(new f(`Canvas toBlob returned null`))},t,n)})};function m(e){return async(t,n=`image/webp`,r)=>{try{let i=t(),a=new Uint8ClampedArray(i.data);return await e.encode({data:a,width:i.width,height:i.height},n,r)}catch(e){return console.warn(`Worker encoding failed, falling back to main-thread Canvas:`,e),p(t,n,r)}}}export{m as n,p as r,d as t};